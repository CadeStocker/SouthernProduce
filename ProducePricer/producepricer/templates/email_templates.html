{% extends "base.html" %}
{% block title %}Email Templates{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <strong>Create / Preview Template</strong>
        </div>
        <div class="card-body">
          <form method="POST">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.name.label(class="form-label") }}
              {{ form.name(class="form-control") }}
            </div>
            <div class="form-group">
              {{ form.subject.label(class="form-label") }}
              {{ form.subject(class="form-control") }}
            </div>
            <div class="form-group">
              {{ form.body.label(class="form-label") }}
              {{ form.body(class="form-control", rows=8) }}
              <small class="form-text text-muted">
                You may use Jinja placeholders: <code>{{ '{{ sheet.name }}' }}</code>, <code>{{ '{{ recipient }}' }}</code>, <code>{{ '{{ sheet_url }}' }}</code>, <code>{{ '{{ company.name }}' }}</code>.<br>
                <strong>Tip:</strong> Press Enter to create line breaks - they will be preserved in the email.
              </small>
            </div>
            <div class="form-check mb-3">
              {{ form.is_default(class="form-check-input") }}
              {{ form.is_default.label(class="form-check-label") }}
            </div>
            <div class="d-flex justify-content-between">
              {{ form.submit(class="btn btn-primary") }}
              <button type="button" class="btn btn-secondary" id="previewBtn">Preview</button>
            </div>
          </form>
        </div>
      </div>

      <div id="previewCard" class="card d-none">
        <div class="card-header"><strong>Preview</strong></div>
        <div class="card-body">
          <h5 id="previewSubject" class="card-title"></h5>
          <div id="previewBody" class="card-text"></div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <strong>Your Templates</strong>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th style="width:6%">Default</th>
                  <th>Name</th>
                  <th>Subject</th>
                  <th style="width:28%">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for t in templates %}
                <tr>
                  <td class="align-middle text-center">{% if t.is_default %}✔{% endif %}</td>
                  <td class="align-middle">{{ t.name }}</td>
                  <td class="align-middle text-truncate" title="{{ t.subject }}">{{ t.subject }}</td>
                  <td class="align-middle">
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.edit_email_template', template_id=t.id) }}">Edit</a>

                    <form method="POST" action="{{ url_for('main.delete_email_template', template_id=t.id) }}" style="display:inline;">
                        {{ delete_form.hidden_tag() }}
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this template?')">Delete</button>
                    </form>

                    {% if not t.is_default %}
                    <form method="POST" action="{{ url_for('main.set_default_email_template', template_id=t.id) }}" style="display:inline;">
                        {{ delete_form.hidden_tag() }}   {# same CSRF token for this POST form #}
                        <button class="btn btn-sm btn-outline-primary" type="submit">Set default</button>
                    </form>
                    {% else %}
                      <span class="badge badge-success ml-2">Default</span>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-muted">No templates yet.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6 class="mb-2">Tips</h6>
          <ul class="mb-0 small">
            <li>Use Jinja placeholders to insert sheet and company data.</li>
            <li>Preview uses the form content (client-side) — click Preview to inspect before saving.</li>
            <li>Only one template can be default; setting a new default will unset the previous one.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('previewBtn')?.addEventListener('click', function () {
  const subject = document.querySelector('[name="subject"]')?.value || '';
  const body = document.querySelector('[name="body"]')?.value || '';
  const previewCard = document.getElementById('previewCard');
  document.getElementById('previewSubject').textContent = subject;
  // simple newline -> <br> conversion for preview
  document.getElementById('previewBody').innerHTML = body.replace(/\n/g, '<br>');
  previewCard.classList.remove('d-none');
  previewCard.scrollIntoView({behavior: 'smooth'});
});
</script>
{% endblock %}