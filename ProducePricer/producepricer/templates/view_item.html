{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Header and Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Item Details: {{ item.name }}</h1>
    <div>
      <a href="{{ url_for('items') }}" class="btn btn-secondary mb-2">← Back to Items</a>
      <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#editItemModal">Edit Item</button>
    </div>
  </div>

    <!-- Item Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Item Information</h5>
        </div>
        <div class="card-body">
            <p><strong>Item Name:</strong> {{ item.name }}</p>
            <p><strong>Item Code:</strong> {{ item.code }}</p>
            <p><strong>Case Weight:</strong> {{ "%.2f"|format(item.case_weight) }} lbs</p>
            <p><strong>Item Designation:</strong> {{ item.item_designation.value if item.item_designation else 'N/A' }}</p>
            <p><strong>Packaging:</strong> {{ packaging.packaging_type if packaging else 'N/A' }}</p>
            <p><strong>Raw Products:</strong> 
                {% if raw_products %}
                    {{ raw_products|map(attribute='name')|join(', ') }}
                {% else %}
                    None
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Price History Table with Pagination -->
<div class="card mb-4">
    <div class="card-header"><h5>Price History</h5></div>
    <div class="card-body">
        {% if price_history %}
            <table class="table table-striped table-sm">
                <thead><tr><th>Date</th><th>Price</th><th>Customer</th></tr></thead>
                <tbody>
                    {% for entry in price_history %}
                    <tr>
                        <td>{{ entry.date.strftime('%Y-%m-%d') }}</td>
                        <td>${{ "%.2f"|format(entry.price) }}</td>
                        <td>{{ customer_map.get(entry.customer_id, "General Price") }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination Controls for Price History -->
            {% if price_pagination.pages > 1 %}
            <nav aria-label="Price History Pagination" class="mt-3">
                <ul class="pagination justify-content-center">
                    <!-- Previous button -->
                    <li class="page-item {% if price_pagination.page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.prev_num, cost_page=cost_pagination.page, info_page=info_pagination.page) if price_pagination.has_prev else '#' }}">&laquo;</a>
                    </li>
                    
                    <!-- Page numbers -->
                    {% for page_num in price_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == price_pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=page_num, cost_page=cost_pagination.page, info_page=info_pagination.page) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Next button -->
                    <li class="page-item {% if price_pagination.page == price_pagination.pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.next_num, cost_page=cost_pagination.page, info_page=info_pagination.page) if price_pagination.has_next else '#' }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
            
            <hr>
            <canvas id="itemPriceChart" width="400" height="180"></canvas>
        {% else %}
            <p class="text-muted">No price history available for this item.</p>
        {% endif %}
    </div>
</div>

    <!-- Cost History Table with Pagination -->
<div class="card mb-4">
    <div class="card-header"><h5>Cost History</h5></div>
    <div class="card-body">
        {% if item_costs %}
            <table class="table table-striped table-sm">
                <thead><tr><th>Date</th><th>Total Cost</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for cost in item_costs %}
                    <tr>
                        <td><a href="{{ url_for('view_item_cost', item_cost_id=cost.id) }}">{{ cost.date.strftime('%Y-%m-%d') }}</a></td>
                        <td>${{ "%.2f"|format(cost.total_cost) }}</td>
                        <td><a href="{{ url_for('delete_item_cost', item_cost_id=cost.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination Controls for Cost History -->
            {% if cost_pagination.pages > 1 %}
            <nav aria-label="Cost History Pagination" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if cost_pagination.page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=cost_pagination.prev_num, info_page=info_pagination.page) if cost_pagination.has_prev else '#' }}">&laquo;</a>
                    </li>
                    
                    {% for page_num in cost_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == cost_pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=page_num, info_page=info_pagination.page) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if cost_pagination.page == cost_pagination.pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=cost_pagination.next_num, info_page=info_pagination.page) if cost_pagination.has_next else '#' }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
            
            <hr>
            <canvas id="itemCostChart" width="400" height="180"></canvas>
        {% else %}
            <p class="text-muted">No cost history available for this item.</p>
        {% endif %}
    </div>
</div>

<!-- Yield & Labor History Table with Pagination -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Yield & Labor History</h5>
        <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#addItemInfoModal-{{ item.id }}">Add Info</button>
    </div>
    <div class="card-body">
        {% if item_info %}
            <table class="table table-striped table-sm">
                <thead><tr><th>Date</th><th>Product Yield</th><th>Labor Hours</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for info in item_info %}
                    <tr>
                        <td>{{ info.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ "%.2f"|format(info.product_yield) }}</td>
                        <td>{{ "%.2f"|format(info.labor_hours) }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('delete_item_info', item_info_id=info.id) }}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination Controls for Yield & Labor -->
            {% if info_pagination.pages > 1 %}
            <nav aria-label="Info History Pagination" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if info_pagination.page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=cost_pagination.page, info_page=info_pagination.prev_num) if info_pagination.has_prev else '#' }}">&laquo;</a>
                    </li>
                    
                    {% for page_num in info_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == info_pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=cost_pagination.page, info_page=page_num) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if info_pagination.page == info_pagination.pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('view_item', item_id=item.id, price_page=price_pagination.page, cost_page=cost_pagination.page, info_page=info_pagination.next_num) if info_pagination.has_next else '#' }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
            
            <hr>
            <canvas id="itemInfoChart" width="400" height="180"></canvas>
        {% else %}
            <p class="text-muted">No yield or labor history available for this item.</p>
        {% endif %}
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const getColor = () => 
    `rgb(${~~(Math.random()*200)},${~~(Math.random()*200)},${~~(Math.random()*200)})`;

  // 1) PRICE HISTORY by Customer
const priceData = {{ price_chart_data|tojson }};
const priceCanvas = document.getElementById('itemPriceChart');
if (priceCanvas) {
  if (!priceData || Object.keys(priceData).length === 0) {
    priceCanvas.insertAdjacentHTML(
      'afterend',
      '<p class="text-warning">No price data available.</p>'
    );
  } else {
    // Convert string dates to Date objects for proper time-based sorting
    const datasets = Object.entries(priceData).map(([name, pts]) => {
      // First sort the points by date
      const sortedPts = [...pts].sort((a, b) => new Date(a.x) - new Date(b.x));
      
      // Then convert the string dates to Date objects for Chart.js
      const formattedPts = sortedPts.map(pt => ({
        x: new Date(pt.x), // Convert string to Date object
        y: pt.y
      }));
      
      return {
        label: name,
        data: formattedPts,
        borderColor: getColor(),
        backgroundColor: getColor(),
        fill: false,
        tension: 0.1
      };
    });

    new Chart(priceCanvas.getContext('2d'), {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Price History by Customer' }
        },
        scales: {
          x: { 
            type: 'time',
            time: { unit: 'day' },
            title: { display: true, text: 'Date' } 
          },
          y: { title: { display: true, text: 'Price ($)' } }
        }
      }
    });
  }
}

  //
  // 2) COST HISTORY
  //
  const costCanvas = document.getElementById('itemCostChart');
  if (costCanvas) {
    const labels = [{% for c in all_item_costs %}"{{ c.date.strftime('%Y-%m-%d') }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    const data   = [{% for c in all_item_costs %}{{ "%.2f"|format(c.total_cost) }}{% if not loop.last %}, {% endif %}{% endfor %}].reverse();
    new Chart(costCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Total Cost',
          data,
          borderColor: 'rgba(54,162,235,1)',
          backgroundColor: 'rgba(54,162,235,0.2)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { title: { display: true, text: 'Cost ($)' } }
        }
      }
    });
  }

  //
  // 3) YIELD & LABOR HISTORY
  //
  const infoCanvas = document.getElementById('itemInfoChart');
  if (infoCanvas) {
    const labels = [{% for i in all_item_info %}"{{ i.date.strftime('%Y-%m-%d') }}"{% if not loop.last %}, {% endif %}{% endfor %}].reverse();
    const yieldD = [{% for i in all_item_info %}{{ "%.2f"|format(i.product_yield) }}{% if not loop.last %}, {% endif %}{% endfor %}].reverse();
    const laborD = [{% for i in all_item_info %}{{ "%.2f"|format(i.labor_hours or 0) }}{% if not loop.last %}, {% endif %}{% endfor %}].reverse();
    new Chart(infoCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Product Yield',
            data: yieldD,
            borderColor: 'rgba(75,192,192,1)',
            backgroundColor: 'rgba(75,192,192,0.2)',
            tension: 0.3
          },
          {
            label: 'Labor Hours',
            data: laborD,
            borderColor: 'rgba(255,99,132,1)',
            backgroundColor: 'rgba(255,99,132,0.2)',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { title: { display: true, text: 'Value' }, beginAtZero: true }
        }
      }
    });
  }
});
</script>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Item: {{ item.name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('edit_item', item_id=item.id) }}">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="case_weight">Case Weight</label>
                        {{ form.case_weight(class="form-control", id="case_weight") }}
                    </div>
                    <div class="form-group">
                        <label for="unit_of_weight">Unit of Weight</label>
                        {{ form.unit_of_weight(class="form-control", id="unit_of_weight") }}
                    </div>
                    <div class="form-group">
                        <label for="item_designation">Item Designation</label>
                        {{ form.item_designation(class="form-control", id="item_designation") }}
                    </div>
                    <div class="form-group form-check">
                        {{ form.ranch(class="form-check-input", id="ranch") }}
                        <label class="form-check-label" for="ranch">Ranch</label>
                    </div>
                    <div class="form-group">
                        <label for="packaging">Packaging</label>
                        {{ form.packaging(class="form-control", id="packaging") }}
                    </div>
                    <div class="form-group">
                        <label for="raw_products">Raw Products</label>
                        {{ form.raw_products(class="form-control", id="raw_products") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Item Info Modal -->
<div class="modal fade" id="addItemInfoModal-{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="addItemInfoModalLabel-{{ item.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemInfoModalLabel-{{ item.id }}">Add Item Info for {{ item.name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('update_item', item_id=item.id) }}">
                {{ update_item_info_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="form-group">
                        {{ update_item_info_form.product_yield.label(class="form-control-label") }}
                        {{ update_item_info_form.product_yield(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ update_item_info_form.labor_hours.label(class="form-control-label") }}
                        {{ update_item_info_form.labor_hours(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ update_item_info_form.date.label(class="form-control-label") }}
                        {{ update_item_info_form.date(class="form-control") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Info</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}