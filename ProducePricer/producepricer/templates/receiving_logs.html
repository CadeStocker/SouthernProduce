{% extends "base.html" %}
{% block title %}Receiving Logs{% endblock %}

{% block content %}
<div class="container-fluid mt-5" style="max-width: 95%;">
  <h1 class="mb-4">Receiving Logs</h1>

  <!-- Action Buttons -->
  <div class="mb-3">
    {# Toggle pagination / show all #}
    {% if use_pagination %}
      <a href="{{ url_for('main.receiving_logs', q=q) }}" class="btn btn-outline-secondary">Show All</a>
    {% else %}
      <a href="{{ url_for('main.receiving_logs', q=q, paginate=1) }}" class="btn btn-outline-secondary">Use Pagination</a>
    {% endif %}
  </div>

  <!-- Search Form -->
  <form method="GET" action="{{ url_for('main.receiving_logs') }}" class="form-inline mb-4">
    <input type="text" name="q" class="form-control mr-2" placeholder="Search logs..." value="{{ q }}">
    <button type="submit" class="btn btn-outline-primary mr-2">Search</button>
    {% if q %}
      <a href="{{ url_for('main.receiving_logs') }}" class="btn btn-link">Clear</a>
    {% endif %}
  </form>

  {% if logs %}
    <div class="card mb-4">
      <div class="card-header">
        <strong>Receiving Logs ({{ logs|length }} entries{% if use_pagination and pagination %}, page {{ pagination.page }} of {{ pagination.pages }}{% endif %})</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0" style="min-width: 1600px; white-space: nowrap;">
            <thead>
              <tr>
                <th style="min-width: 120px;">Date & Time</th>
                <th style="min-width: 150px;">Raw Product</th>
                <th style="min-width: 120px;">Brand Name</th>
                <th style="min-width: 70px;">Quantity</th>
                <th style="min-width: 100px;">Pack Size</th>
                <th style="min-width: 100px;">Price Paid</th>
                <th style="min-width: 120px;">Seller</th>
                <th style="min-width: 100px;">Temperature (°F)</th>
                <th style="min-width: 80px;">Hold/Used</th>
                <th style="min-width: 140px;">Grower/Distributor</th>
                <th style="min-width: 100px;">Country</th>
                <th style="min-width: 120px;">Received By</th>
                <th style="min-width: 100px;">Returned</th>
                <th style="min-width: 80px;">Images</th>
                <th style="min-width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td>{{ log.datetime.strftime('%Y-%m-%d %H:%M') if log.datetime else 'N/A' }}</td>
                <td>
                  {% if log.raw_product %}
                    <a href="{{ url_for('main.view_raw_product', raw_product_id=log.raw_product.id) }}">
                      {{ log.raw_product.name }}
                    </a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if log.brand_name %}
                    {{ log.brand_name.name }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ log.quantity_received }}</td>
                <td>{{ log.pack_size }} {{ log.pack_size_unit }}</td>
                <td>
                  {% if log.price_paid %}
                    {% set comparison = log.get_price_comparison() %}
                    {% if comparison and comparison.master_price %}
                      <div>
                        <div><strong>Paid:</strong> ${{ "%.2f"|format(log.price_paid) }}</div>
                        <div class="text-muted small">Market: ${{ "%.2f"|format(comparison.master_price) }}</div>
                        {% if comparison.status == 'above_market' %}
                          <span class="badge badge-danger" title="Above market by ${{ '%.2f'|format(comparison.difference) }} ({{ '%.1f'|format(comparison.percentage) }}%)">
                            ↑ {{ '%.1f'|format(comparison.percentage) }}%
                          </span>
                        {% elif comparison.status == 'below_market' %}
                          <span class="badge badge-success" title="Below market by ${{ '%.2f'|format(-comparison.difference) }} ({{ '%.1f'|format(-comparison.percentage) }}%)">
                            ↓ {{ '%.1f'|format(-comparison.percentage) }}%
                          </span>
                        {% elif comparison.status == 'at_market' %}
                          <span class="badge badge-secondary" title="At market price">
                            = Market
                          </span>
                        {% endif %}
                      </div>
                    {% else %}
                      <div>
                        <strong>${{ "%.2f"|format(log.price_paid) }}</strong>
                        {% if comparison and comparison.status == 'no_market_data' %}
                          <br><small class="text-muted">No market data</small>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if log.seller %}
                    {{ log.seller.name }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ log.temperature|round(1) }}</td>
                <td>
                  <span class="badge badge-{{ 'warning' if log.hold_or_used == 'hold' else 'success' }}">
                    {{ log.hold_or_used|upper }}
                  </span>
                </td>
                <td>
                  {% if log.grower_or_distributor %}
                    {{ log.grower_or_distributor.name }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ log.country_of_origin }}</td>
                <td>{{ log.received_by }}</td>
                <td>{{ log.returned if log.returned else '-' }}</td>
                <td>
                  {% if log.images %}
                    <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#imagesModal-{{ log.id }}">
                      View ({{ log.images|length }})
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('main.view_receiving_log', log_id=log.id) }}" class="btn btn-sm btn-primary">
                    View Details
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if use_pagination and pagination and pagination.pages > 1 %}
    <div class="d-flex justify-content-end mt-3">
      <nav aria-label="Receiving Logs pagination">
        <ul class="pagination">
          {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.receiving_logs', page=pagination.prev_num, q=q, paginate=1) }}">&laquo; Prev</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; Prev</span></li>
          {% endif %}
          {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
            {% if p %}
              {% if p == pagination.page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('main.receiving_logs', page=p, q=q, paginate=1) }}">{{ p }}</a></li>
              {% endif %}
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}
          {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.receiving_logs', page=pagination.next_num, q=q, paginate=1) }}">Next &raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}

    {# Image Modals per log #}
    {% for log in logs %}
    {% if log.images %}
    <!-- Images Modal -->
    <div class="modal fade" id="imagesModal-{{ log.id }}" tabindex="-1" role="dialog" aria-labelledby="imagesModalLabel-{{ log.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imagesModalLabel-{{ log.id }}">
              Images for {{ log.raw_product.name if log.raw_product else 'Log' }} - {{ log.datetime.strftime('%Y-%m-%d %H:%M') }}
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              {% for image in log.images %}
              <div class="col-md-6 mb-3">
                <img src="{{ url_for('main.get_receiving_image', filename=image.filename) }}" 
                     class="img-fluid" 
                     alt="Receiving Image"
                     style="max-width: 100%; height: auto;">
                <p class="text-muted small mt-1">Uploaded: {{ image.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</p>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  {% else %}
    <div class="alert alert-info" role="alert">
      {% if q %}
        No receiving logs found matching "{{ q }}".
      {% else %}
        No receiving logs found. Logs will appear here once they are submitted through the mobile app.
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
